#include <SPI.h>
#include <Ethernet.h>
#include <OSCMessage.h>

// Déclaration des variables réseau avec l'adresse MAC formatée correctement
byte mac[] = { 0x90, 0xA2, 0xDA, 0x10, 0x4F, 0xF9 }; // Adresse MAC correcte (sans tirets)
IPAddress ip(192.168.1.101); // Adresse IP de l'Arduino
IPAddress outIp(192.168.1.100); // Adresse IP de l'ordinateur
unsigned int outPort = 8000;  // Port OSC sur lequel TouchDesigner écoute

EthernetUDP Udp; // UDP instance pour envoyer les messages

void setup() {
  // Initialisation de la communication Ethernet
  Ethernet.begin(mac, ip);
  Udp.begin(8000); // Le port de réception d'OSC de l'Arduino (facultatif si c'est juste pour envoyer)

  Serial.begin(9600);  // Initialisation du port série
  delay(1000);  // Petit délai pour s'assurer que tout est bien configuré

  Serial.println("Direct Ethernet connection ready. Starting OSC transmission...");
}

void loop() {
  int sensorValue = analogRead(A0);  // Lecture de la valeur du capteur
  int vitesse = map(sensorValue, 1, 1023, 1, 10);  // Mappage de la valeur pour la vitesse

  // Création d'un message OSC avec l'adresse /vitesse
  OSCMessage msg("/vitesse");
  msg.add(vitesse);  // Ajout de la valeur de vitesse

  // Envoi du message OSC via Ethernet
  Udp.beginPacket(outIp, outPort);  // Démarrage du paquet vers l'adresse IP de l'ordinateur
  msg.send(Udp);  // Envoi du message
  Udp.endPacket();  // Fin du paquet

  msg.empty();  // Nettoyage du message OSC

  // Pour le débogage
  Serial.print("Vitesse : ");
  Serial.println(vitesse);

  delay(200);  // Pause avant la prochaine lecture
}